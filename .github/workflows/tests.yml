name: CI Tests

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    backend:
        name: Backend Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "npm"
                  cache-dependency-path: backend/package-lock.json

            - name: Install dependencies
              working-directory: ./backend
              run: npm ci

            - name: Generate Prisma Client
              working-directory: ./backend
              run: npx prisma generate

            - name: Run linter
              working-directory: ./backend
              run: npm run lint -- --max-warnings=0

            - name: Run tests
              working-directory: ./backend
              run: npm run test

            - name: Build
              working-directory: ./backend
              run: npm run build

    frontend:
        name: Frontend Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: ./frontend
              run: npm ci

            - name: Run linter
              working-directory: ./frontend
              run: npm run lint -- --max-warnings=0

            - name: Run tests
              working-directory: ./frontend
              run: npm run test

            - name: Build
              working-directory: ./frontend
              run: npm run build

    services-health-check:
        name: Services Health Check
        runs-on: ubuntu-latest
        needs: [backend, frontend]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker
              uses: docker/setup-buildx-action@v3
              
            - name: Create .env.build from example
              run: |
                  cp example.env .env.build

                  # Remove Google credentials
                  sed -i 's/^GOOGLE_CLIENT_ID=.*/GOOGLE_CLIENT_ID=/' .env.build
                  sed -i 's/^GOOGLE_CLIENT_SECRET=.*/GOOGLE_CLIENT_SECRET=/' .env.build
                  sed -i 's/^GOOGLE_REDIRECT_URI=.*/GOOGLE_REDIRECT_URI=/' .env.build

            - name: Start services
              run: docker compose -f build-docker-compose.yml --env-file .env.build up -d

            - name: Wait for services to be healthy
              run: |
                  echo "Waiting for database..."
                  timeout 60 sh -c 'until docker compose -f build-docker-compose.yml ps db | grep -q "healthy"; do sleep 2; done'

                  echo "Waiting for backend..."
                  timeout 90 sh -c 'until docker compose -f build-docker-compose.yml ps backend | grep -q "healthy"; do sleep 2; done'

                  echo "Waiting for frontend..."
                  timeout 60 sh -c 'until docker compose -f build-docker-compose.yml ps frontend | grep -q "healthy"; do sleep 2; done'

            - name: Test backend health
              run: docker compose -f build-docker-compose.yml exec -T backend wget -qO- http://127.0.0.1:4000/health

            - name: Test frontend accessibility
              run: curl -f http://localhost:3000 || exit 1

            - name: Show service logs
              if: failure()
              run: |
                  echo "=== Backend Logs ==="
                  docker compose -f build-docker-compose.yml logs backend
                  echo "=== Frontend Logs ==="
                  docker compose -f build-docker-compose.yml logs frontend
                  echo "=== Database Logs ==="
                  docker compose -f build-docker-compose.yml logs db

            - name: Stop services
              if: always()
              run: docker compose -f build-docker-compose.yml down -v
